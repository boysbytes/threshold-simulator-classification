<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Threshold Simulation for Classifiers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  
  <style>
    :root {
      --primary-color: #7f6af7;
      --secondary-color: #8b89a8;
      --background-color: #f7f7fb;
      --card-background: #f9faff;
      --card-shadow: 0 2px 8px #efeefa6a;
      --text-color: #313164;
      --light-text: #666;
      --tp-color: #5eb979;
      --fp-color: #ea5252;
      --fn-color: #f8a12f;
      --tn-color: #3393e6;
      --slider-accent: #63e6be;
      --border-color: #ccc;
      --border-radius: 5px;
    }

    body {
      background: var(--background-color);
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: 0 12px 28px rgba(120, 120, 180, 0.11);
      padding: 36px 26px 18px;
    }

    h1 {
      font-size: 2.4em;
      font-weight: 800;
      text-align: center;
      margin-bottom: 0;
      color: var(--primary-color);
      letter-spacing: 1px;
    }

    .subtitle {
      text-align: center;
      font-size: 1.1em;
      color: var(--secondary-color);
      margin: 4px 0 26px;
    }

    .dataset-btns {
      display: flex;
      gap: 15px;
    }

    .dataset-btn {
      border: 1px solid var(--border-color);
      background: #fff;
      color: grey;
      font-size: 1em;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .dataset-btn.active {
      background: #e0e0e0;
    }

    .slider-center {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .slider-box {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 1.05em;
      font-weight: 600;
    }

    .slider-box span {
      color: var(--text-color);
    }

    .slider {
      width: 180px;
      accent-color: var(--slider-accent);
    }

    .slider-value {
      min-width: 48px;
      margin-left: 3px;
      color: var(--text-color);
    }

    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 28px;
      margin-top: 14px;
    }

    .first-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 28px;
      align-items: start;
    }

    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      padding: 26px 22px 22px;
      box-shadow: var(--card-shadow);
    }

    .confusion-matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
      text-align: center;
      margin-top: 8px;
    }

    .confusion-matrix-table th,
    .confusion-matrix-table td {
      padding: 10px 16px;
    }

    .confusion-matrix-table th {
      background: var(--card-background);
      color: grey;
      font-weight: 400;
    }

    .confusion-matrix-table .row-label {
      background: var(--card-background);
      color: grey;
      font-weight: 400;
    }

    .cm-tp { background: var(--tp-color); color: #fff; }
    .cm-fp { background: var(--fp-color); color: #fff; }
    .cm-fn { background: var(--fn-color); color: #fff; }
    .cm-tn { background: var(--tn-color); color: #fff; }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 12px;
    }

    .metric-box {
      text-align: center;
    }

    .metric-label {
      color: var(--primary-color);
      font-size: 0.98em;
      font-weight: 500;
    }

    .metric-value {
      font-size: 1.44em;
      font-weight: bold;
      color: #252550;
    }

    details.card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      padding: 22px;
      box-shadow: var(--card-shadow);
    }

    details.card summary {
      cursor: pointer;
      font-weight: 700;
      font-size: 1.12em;
      color: var(--text-color);
      list-style: none;
      margin: 0;
      padding: 0;
    }

    details.card summary::-webkit-details-marker {
      display: none;
    }

    details.card[open] summary::before {
      content: "▼ ";
    }

    details.card:not([open]) summary::before {
      content: "► ";
    }

    .footer-note {
      text-align: left;
      font-size: 0.85em;
      margin-top: 12px;
      color: var(--light-text);
    }

    .axis text {
      fill: var(--light-text);
      font-size: 13px;
    }

    .x-axis-label {
      font-weight: 600;
      font-size: 1em;
      fill: #333;
    }

    .shade {
      fill: #ffd2d2;
      opacity: 0.30;
    }

    .threshold-line {
      stroke: #e63946;
      stroke-width: 2;
      stroke-dasharray: 4 3;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Threshold Simulation for Classifiers</h1>
    <div class="subtitle">
      Explore how classification threshold affects model performance across different datasets
    </div>

    <main class="main-panel">
      <div class="first-row">
        <!-- -------------- LEFT PANEL ------------------------------------ -->
        <section class="card">
          <h3>Distribution and Predictions</h3>

          <!-- SVG – dynamic height, dynamic width -->
          <svg id="scorePlot" preserveAspectRatio="none" width="100%" height="320"></svg>

          <div class="slider-center">
            <div class="slider-box">
              <span>Classification Threshold</span>
              <input type="range" min="0" max="1" step="0.01"
                     value="0.5" class="slider" id="thresholdSlider">
              <span class="slider-value" id="thresholdValue">0.50</span>
            </div>
          </div>
        </section>

        <!-- -------------- RIGHT PANEL ----------------------------------- -->
        <aside class="right-panel">
          <div class="card">
            <h3>Dataset</h3>
            <div class="dataset-btns">
              <button class="dataset-btn active" data-ds="separated">Separated</button>
              <button class="dataset-btn" data-ds="overlapped">Overlapped</button>
              <button class="dataset-btn" data-ds="imbalanced">Imbalanced</button>
            </div>
          </div>

          <div class="card">
            <h3>Confusion Matrix</h3>
            <table class="confusion-matrix-table">
              <tr><th></th><th>Actual&nbsp;Positive</th><th>Actual&nbsp;Negative</th></tr>
              <tr>
                <td class="row-label">Pred.&nbsp;Positive</td>
                <td class="cm-tp">▢<br>TP&nbsp;=&nbsp;<span id="cm-tp-count">0</span></td>
                <td class="cm-fp">◉<br>FP&nbsp;=&nbsp;<span id="cm-fp-count">0</span></td>
              </tr>
              <tr>
                <td class="row-label">Pred.&nbsp;Negative</td>
                <td class="cm-fn">▣<br>FN&nbsp;=&nbsp;<span id="cm-fn-count">0</span></td>
                <td class="cm-tn">○<br>TN&nbsp;=&nbsp;<span id="cm-tn-count">0</span></td>
              </tr>
            </table>
          </div>
        </aside>
      </div>

      <div class="second-row">
        <details class="card">
          <summary>Performance Metrics</summary>
          <div class="metrics-grid" style="margin-top:14px;">
            <div class="metric-box"><div class="metric-label">Accuracy</div><div class="metric-value" id="acc-metric">0.00</div></div>
            <div class="metric-box"><div class="metric-label">Precision</div><div class="metric-value" id="prec-metric">0.00</div></div>
            <div class="metric-box"><div class="metric-label">Recall</div><div class="metric-value" id="recall-metric">0.00</div></div>
            <div class="metric-box"><div class="metric-label">F1&nbsp;Score</div><div class="metric-value" id="f1-metric">0.00</div></div>
          </div>
        </details>
      </div>
    </main>

    <footer class="footer-note">
      Adjust the threshold slider to see how the balance between false positives and false negatives shifts.
    </footer>
  </div>

  <!-- ==================  SCRIPT  ================== -->
  <script>
    /* ───────── constants ───────── */
    const SYMBOL_SPACING_Y  = 18;  // vertical gap between stacked dots
    const SYMBOL_HALF_WIDTH = 8;   // half glyph width for x-axis over-hang
    const fixedHeight       = 300; // minimum inner plot height
    const margin            = { top:20, right:20, bottom:40, left:40 };

    /* ───────── dataset factory ───────── */
    function generateDatasets() {
      const datasets = {};
      function normalRandom(mean, std) {
        let u = 0, v = 0;
        while (u === 0) u = Math.random();
        while (v === 0) v = Math.random();
        const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2 * Math.PI * v);
        return Math.max(0, Math.min(1, z * std + mean));
      }
      ['separated', 'overlapped', 'imbalanced'].forEach(ds => {
        const arr = [];
        for (let i = 0; i < 100; i++) {
          const label = ds === 'imbalanced' ? (i < 80 ? 0 : 1) : (i < 50 ? 0 : 1);
          const mean = label
            ? (ds === 'separated' ? 0.8 : ds === 'overlapped' ? 0.6 : 0.7)
            : (ds === 'separated' ? 0.2 : ds === 'overlapped' ? 0.4 : 0.3);
          const std  = label
            ? (ds === 'separated' ? 0.1 : ds === 'overlapped' ? 0.2 : 0.15)
            : (ds === 'separated' ? 0.1 : ds === 'overlapped' ? 0.2 : 0.15);
          arr.push({ id:i, score:normalRandom(mean,std), label });
        }
        datasets[ds] = arr;
      });
      return datasets;
    }

    /* ───────── globals & static SVG scaffold ───────── */
    const datasets = generateDatasets();
    let currentDataset   = 'separated';
    let currentThreshold = 0.5;

    const svg   = d3.select('#scorePlot').attr('data-h', fixedHeight);
    const plotG = svg.append('g')
                     .attr('transform', `translate(${margin.left},${margin.top})`);

    const xScale = d3.scaleLinear().domain([0, 1]);   // range filled each draw

    plotG.append('g').attr('class','axis x-axis');
    plotG.append('text')
         .attr('class','x-axis-label')
         .attr('text-anchor','middle')
         .attr('font-weight',600)
         .attr('font-size','1.09em')
         .attr('fill','#222')
         .text('Model Score');

    const shadeRect     = plotG.append('rect').attr('class','shade');
    const thresholdLine = plotG.append('line').attr('class','threshold-line');

    /* ───────── MAIN RENDER ───────── */
    function updateVisualization() {
      const data = datasets[currentDataset];

      /* current usable width of the plot area */
      const plotWidth = svg.node().getBoundingClientRect().width
                        - margin.left - margin.right;

      /* make scale & SVG aware of that width */
      xScale.range([0, plotWidth]);
      svg.attr('viewBox',
        `0 0 ${plotWidth + margin.left + margin.right}`
        +` ${+svg.attr('data-h') + margin.top + margin.bottom}`);

      /* bin data to nearest 0.1 */
      const tickPositions = d3.range(0, 1.1, 0.1);
      const tickBins = {}; tickPositions.forEach(t => tickBins[t] = []);
      data.forEach(d => {
        const pred   = d.score >= currentThreshold ? 1 : 0;
        const cat    = d.label ? (pred ? 'tp':'fn') : (pred ? 'fp':'tn');
        const tick   = tickPositions.reduce((p,c)=>
                        Math.abs(c-d.score) < Math.abs(p-d.score) ? c : p);
        tickBins[tick].push({ ...d, category:cat });
      });

      /* dynamic height so stacks never clip */
      const bottomPadding  = 6;
      const textHeight     = 18;
      const maxStackDepth  = d3.max(Object.values(tickBins), b => b.length) || 0;
      const height = Math.max(
        fixedHeight,
        bottomPadding + textHeight + SYMBOL_SPACING_Y * maxStackDepth
      );
      const innerHeight = height - bottomPadding;

      /* only touch svg.height / viewBox if that changed  */
      if (+svg.attr('data-h') !== height) {
        svg.attr('viewBox',
          `0 0 ${plotWidth + margin.left + margin.right}`
          +` ${height + margin.top + margin.bottom}`)
           .attr('height', height + margin.top + margin.bottom)
           .attr('data-h', height);
      }

      /* x-axis */
      plotG.select('.x-axis')
           .attr('transform', `translate(0,${innerHeight})`)
           .call(
             d3.axisBottom(xScale)
               .ticks(11)
               .tickValues(tickPositions)
               .tickFormat(d3.format('.1f'))
               .tickSizeOuter(0)
           )
           .selectAll('text').attr('font-size','14px');

      /* extend domain line so symbols over-hang nicely */
      plotG.select('.x-axis').select('path.domain')
           .attr('d', `M${-SYMBOL_HALF_WIDTH},0H${plotWidth + SYMBOL_HALF_WIDTH}`);

      plotG.select('.x-axis-label')
           .attr('x', plotWidth / 2)
           .attr('y', innerHeight + margin.bottom - 5);

      /* threshold guide */
      thresholdLine
        .attr('x1', xScale(currentThreshold))
        .attr('x2', xScale(currentThreshold))
        .attr('y1', 0)
        .attr('y2', innerHeight);

      /* shaded FP area */
      shadeRect
        .attr('x', xScale(currentThreshold))
        .attr('y', 0)
        .attr('width', Math.max(0, plotWidth + SYMBOL_HALF_WIDTH - xScale(currentThreshold)))
        .attr('height', innerHeight);

      /* stacked glyphs */
      const stacked = [];
      Object.entries(tickBins).forEach(([tick, bin]) => {
        bin.forEach((d,i)=>stacked.push({
          ...d,
          centerX:+tick,
          stackIndex:i
        }));
      });

      const pts = plotG.selectAll('.point-dot').data(stacked, d=>d.id);

      pts.enter().append('text')
        .attr('class','point-dot')
        .attr('font-family','Arial')
        .attr('font-size','16px')
        .attr('text-anchor','middle')
        .merge(pts)
        .attr('x', d => xScale(d.centerX))
        .attr('y', d => innerHeight - (d.stackIndex+1)*SYMBOL_SPACING_Y)
        .attr('dominant-baseline','middle')
        .text(d => d.category==='tp' ? '▢'
               : d.category==='fp' ? '◉'
               : d.category==='fn' ? '▣' : '○')
        .attr('fill', d => d.category==='tp'? '#5eb979'
                       : d.category==='fn'? '#f8a12f'
                       : d.category==='tn'? '#3393e6'
                       : '#ea5252');

      pts.exit().remove();

      /* confusion matrix & metrics */
      let tp=0, fp=0, fn=0, tn=0;
      data.forEach(d=>{
        const p = d.score >= currentThreshold ? 1 : 0;
        if (d.label && p) tp++;
        else if (!d.label && p) fp++;
        else if (d.label && !p) fn++;
        else tn++;
      });

      document.getElementById('cm-tp-count').textContent = tp;
      document.getElementById('cm-fp-count').textContent = fp;
      document.getElementById('cm-fn-count').textContent = fn;
      document.getElementById('cm-tn-count').textContent = tn;

      const acc = (tp+tn)/data.length,
            prec= tp+fp? tp/(tp+fp) : 0,
            rec = tp+fn? tp/(tp+fn) : 0,
            f1  = prec+rec? 2*prec*rec/(prec+rec) : 0;

      document.getElementById('acc-metric').textContent    = acc.toFixed(3);
      document.getElementById('prec-metric').textContent   = prec.toFixed(3);
      document.getElementById('recall-metric').textContent = rec.toFixed(3);
      document.getElementById('f1-metric').textContent     = f1.toFixed(3);
    }

    /* ───────── interactions ───────── */
    document.getElementById('thresholdSlider').addEventListener('input', e => {
      currentThreshold = +e.target.value;
      document.getElementById('thresholdValue').textContent = currentThreshold.toFixed(2);
      updateVisualization();
    });

    document.querySelectorAll('.dataset-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.dataset-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentDataset   = this.dataset.ds;
        currentThreshold = 0.5;
        document.getElementById('thresholdSlider').value = 0.5;
        document.getElementById('thresholdValue').textContent = '0.50';
        updateVisualization();
      });
    });

    /* ───────── initial draw & resize hook ───────── */
    updateVisualization();
    window.addEventListener('resize', updateVisualization);
  </script>
</body>
</html>
