<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Threshold Tuning for Binary Classifiers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    body {
      background: #f7f7fb;
      font-family: 'Arial', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 12px 28px rgba(120,120,180,0.11);
      padding: 36px 26px 18px;
    }
    h1 {
      font-size: 2.4em; font-weight: 800;
      text-align: center; margin-bottom: 0;
      color: #7f6af7; letter-spacing: 1px;
    }
    .subtitle {
      text-align: center;
      font-size: 1.1em;
      color: #8b89a8;
      margin: 4px 0 26px;
    }
    .controls-row {
      display: flex; align-items: center; justify-content: center;
      gap: 30px;
      background: #f2f3fa; padding: 24px 0 18px;
      border-radius: 5px; margin-bottom: 20px;
      border: 1px solid #e3e1f2;
      box-shadow: 0 1px 3px #d5dafb38;
    }
    .dataset-btns { display: flex; gap: 15px; }
    .dataset-btn {
      border: none; background: #e5e8fd; color: #6651d5;
      font-weight: 600; font-size: 1.08em;
      padding: 8px 22px; border-radius: 24px;
      cursor: pointer; transition: all 0.18s;
    }
    .dataset-btn.active, .dataset-btn:hover {
      background: linear-gradient(90deg, #7e8ffa 80%, #c6b6fa 100%);
      color: #fff; box-shadow: 0 2px 7px #dad6f9;
    }
    .slider-box {
      display: flex; align-items: center; gap: 14px;
      font-size: 1.05em; color: #6651d5;
    }
    .slider {
      width: 180px; accent-color: #63e6be;
      background: linear-gradient(90deg, #fb7185 0%, #63e6be 100%);
      border-radius: 3px; height: 4px;
    }
    .slider-value {
      font-weight: bold; font-size: 1.22em;
      color: #7f6af7; min-width: 48px; margin-left: 3px;
    }

    .main-panel {
      display: flex; flex-direction: column;
      gap: 28px; margin-top: 14px;
    }
    .first-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 28px;
    }
    .card {
      background: #f9faff;
      border-radius: 5px;
      padding: 26px 22px 22px;
      box-shadow: 0 2px 8px #efeefa6a;
    }
    .legend-row {
      display: flex; gap: 20px;
      margin-bottom: 14px; font-size: 1em;
      align-items: center;
    }
    .legend-symbol {
      font-size: 1.6em;
      width: 1.6em;
      display: inline-block;
      text-align: center;
      margin-right: 6px;
      vertical-align: middle;
    }
    .tp-symbol { color: #5eb979; }
    .fn-symbol { color: #f8a12f; }
    .tn-symbol { color: #3393e6; }
    .fp-symbol { color: #ea5252; }

    /* --- Confusion matrix styling --- */
    .confusion-matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
      text-align: center;
      margin-top: 8px;
    }
    .confusion-matrix-table th,
    .confusion-matrix-table td {
      padding: 10px 16px;
    }
    .confusion-matrix-table th {
      background: #f9faff;
      color: grey;
      font-weight: 400;
    }
    .confusion-matrix-table .row-label {
      background: #f9faff;
      color: grey;
      font-weight: 400;
    }
    .cm-tp { background: #5eb979; color: #fff; }
    .cm-fp { background: #ea5252; color: #fff; }
    .cm-fn { background: #f8a12f; color: #fff; }
    .cm-tn { background: #3393e6; color: #fff; }

    .metrics-grid {
      display: grid; grid-template-columns: repeat(2,1fr);
      gap: 14px; margin-top: 10px;
    }
    .metric-box {
      background: #ecebfa;
      border-radius: 5px;
      padding: 14px 10px;
      text-align: center;
    }
    .metric-label {
      color: #7f6af7; font-size: 0.98em; font-weight: 500;
    }
    .metric-value {
      font-size: 1.44em; font-weight: bold; color: #252550;
    }

    .second-row { margin-top: 0; }
    details.card {
      background: #f9faff;
      border-radius: 5px;
      padding: 22px;
      box-shadow: 0 2px 8px #efeefa6a;
    }
    details.card summary {
      cursor: pointer;
      font-weight: 700;
      font-size: 1.12em;
      color: #313164;
      list-style: none;
      margin: 0; padding: 0;
    }
    details.card summary::-webkit-details-marker { display: none; }
    details.card[open] summary::before { content: "â–¼ "; }
    details.card:not([open]) summary::before { content: "â–º "; }

    .footer-note {
      text-align: left;
      background: #f6f4fe;
      color: #837f99;
      font-size: 1.07em;
      margin: 20px 6px 6px 6px;
      padding: 15px 22px;
      border-radius: 5px;
      box-shadow: 0 1px 4px #ececf661;
    }

    .shade {
      fill: #999;
      opacity: 0.1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Threshold Simulation for Classifiers</h1>
    <div class="subtitle">
      Explore how classification threshold affects model performance across different datasets
    </div>

    <div class="controls-row">
      <div>
        <span style="font-weight:600;color:#7f6af7;margin-right:10px;">
          Dataset:
        </span>
        <div class="dataset-btns">
          <button class="dataset-btn active" data-ds="separated">Separated</button>
          <button class="dataset-btn" data-ds="overlapped">Overlapped</button>
          <button class="dataset-btn" data-ds="imbalanced">Imbalanced</button>
        </div>
      </div>
      <div class="slider-box">
        <span>Classification Threshold</span>
        <input type="range" min="0" max="1" step="0.01"
               value="0.5" class="slider" id="thresholdSlider">
        <span class="slider-value" id="thresholdValue">0.50</span>
      </div>
    </div>

    <div class="main-panel">
      <div class="first-row">
        <!-- Distribution -->
        <div class="card">
          <h3>Distribution and Predictions</h3>

          <svg id="scorePlot" width="100%" height="360"></svg>
        </div>

        <!-- Confusion Matrix -->
        <div class="card">
          <h3>Confusion Matrix</h3>
          <table class="confusion-matrix-table">
            <tr>
              <th></th>
              <th>Actual Positive</th>
              <th>Actual Negative</th>
            </tr>
            <tr>
              <td class="row-label">Predicted Positive</td>
              <td class="cm-tp">
                â–¢<br>TP = <span id="cm-tp-count">0</span>
              </td>
              <td class="cm-fp">
                â—‰<br>FP = <span id="cm-fp-count">0</span>
              </td>
            </tr>
            <tr>
              <td class="row-label">Predicted Negative</td>
              <td class="cm-fn">
                â–£<br>FN = <span id="cm-fn-count">0</span>
              </td>
              <td class="cm-tn">
                â—‹<br>TN = <span id="cm-tn-count">0</span>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Performance Metrics Accordion -->
      <div class="second-row">
        <details class="card">
          <summary>Performance Metrics</summary>
          <div class="metrics-grid" style="margin-top:14px;">
            <div class="metric-box">
              <div class="metric-label">Accuracy</div>
              <div class="metric-value" id="acc-metric">0.00</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Precision</div>
              <div class="metric-value" id="prec-metric">0.00</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Recall</div>
              <div class="metric-value" id="recall-metric">0.00</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">F1 Score</div>
              <div class="metric-value" id="f1-metric">0.00</div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="footer-note">
      ðŸ’¡ Drag the threshold slider to see how precision and recall trade off.
      Try different datasets to see how class separation and balance affect performance!
    </div>
  </div>

  <script>
    // --- Synthetic Datasets ---
    function generateDatasets() {
      const datasets = {};
      function normalRandom(mean, std) {
        let u=0, v=0;
        while (u === 0) u = Math.random();
        while (v === 0) v = Math.random();
        const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2 * Math.PI * v);
        return Math.max(0, Math.min(1, z * std + mean));
      }
      ['separated', 'overlapped', 'imbalanced'].forEach(ds => {
        const arr = [];
        const total = ds === 'overlapped' ? 150 : ds === 'imbalanced' ? 200 : 100;
        for (let i = 0; i < total; i++) {
          let label;
          if (ds === 'separated')       label = i < 50  ? 0 : 1;
          else if (ds === 'overlapped')  label = i < 75  ? 0 : 1;
          else                            label = i < 160 ? 0 : 1;
          const mean = label === 1
            ? (ds === 'separated' ? 0.8 : ds === 'overlapped' ? 0.6 : 0.7)
            : (ds === 'separated' ? 0.2 : ds === 'overlapped' ? 0.4 : 0.3);
          const std  = label === 1
            ? (ds === 'separated' ? 0.1 : ds === 'overlapped' ? 0.2 : 0.15)
            : (ds === 'separated' ? 0.1 : ds === 'overlapped' ? 0.2 : 0.15);
          arr.push({ id: i, score: normalRandom(mean, std), label });
        }
        datasets[ds] = arr;
      });
      return datasets;
    }

    const datasets = generateDatasets();
    let currentDataset = 'separated';
    let currentThreshold = 0.5;

    // --- D3 Plot Setup ---
    const svg = d3.select('#scorePlot');
    const margin = { top: 24, right: 40, bottom: 50, left: 54 }; // Increased right margin
    const width  = 800, height = 300;
    const symbolSize = 20;
    const symbolPadding = symbolSize / 2; // Half symbol width for padding
    
    svg
      .attr('viewBox', `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
      .attr('preserveAspectRatio', 'xMidYMid meet');

    const plotG = svg.append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);

    // 1) Legend flush-left
    d3.select('.legend-row')
      .style('margin-left', margin.left + 'px');

    // 2) X-axis with extended domain to accommodate symbol overflow
    const xScale = d3.scaleLinear()
      .domain([-0.05, 1.05]) // Extended domain
      .range([0, width]);
    
    const xAxisG = plotG.append('g')
      .attr('class','axis')
      .attr('transform', `translate(0,${height})`)
      .call(
        d3.axisBottom(xScale)
          .ticks(11)
          .tickValues(d3.range(0, 1.1, 0.1)) // Force ticks at 0.0, 0.1, ..., 1.0
          .tickFormat(d3.format('.1f'))
          .tickSizeOuter(0)
      );
    xAxisG.selectAll('text').attr('font-size','14px');

    // 3) Model Score label
    plotG.append('text')
      .attr('x', width/2)
      .attr('y', height + margin.bottom - 10)
      .attr('text-anchor','middle')
      .attr('font-weight',600)
      .attr('font-size','1.09em')
      .attr('fill','#222')
      .text('Model Score');

    // 4) Stacked Samples label
    plotG.append('text')
      .attr('transform','rotate(-90)')
      .attr('x', -height/2)
      .attr('y', -margin.left + 15)
      .attr('text-anchor','middle')
      .attr('font-size','1.05em')
      .attr('font-weight',600)
      .attr('fill','#222')
      .text('Samples');

    // 5) Shading rectangle behind everything
    const shadeRect = plotG.insert('rect', ':first-child')
      .attr('class','shade')
      .attr('y', 0)
      .attr('x', xScale(currentThreshold))
      .attr('width', Math.max(0, width - xScale(currentThreshold)))
      .attr('height', height);

    // 6) Threshold line
    const thresholdLine = plotG.append('line')
      .attr('stroke','#e22')
      .attr('stroke-dasharray','5,5')
      .attr('stroke-width',3)
      .attr('y1',0).attr('y2',height);

    // --- Update function ---
    function updateVisualization() {
      const data = datasets[currentDataset];
      const stackGap = 2;
      
      // Define tick positions (0.0, 0.1, 0.2, ..., 1.0)
      const tickPositions = d3.range(0, 1.1, 0.1);
      const tickWidth = 0.1;

      // update shading
      shadeRect
        .attr('x', xScale(currentThreshold))
        .attr('width', Math.max(0, width - xScale(currentThreshold)));

      // Assign each data point to the nearest tick
      const tickBins = {};
      tickPositions.forEach(tick => {
        tickBins[tick] = [];
      });

      data.forEach(d => {
        const predicted = d.score >= currentThreshold ? 1 : 0;
        let category;
        if      (d.label===1 && predicted===1) category='tp';
        else if (d.label===1 && predicted===0) category='fn';
        else if (d.label===0 && predicted===0) category='tn';
        else                                   category='fp';
        
        // Find nearest tick
        const nearestTick = tickPositions.reduce((prev, curr) => 
          Math.abs(curr - d.score) < Math.abs(prev - d.score) ? curr : prev
        );
        
        tickBins[nearestTick].push({...d, predicted, category});
      });

      // Create stacked data with positions centered on ticks
      const stackedData = [];
      Object.keys(tickBins).forEach(tickKey => {
        const tick = parseFloat(tickKey);
        tickBins[tick].forEach((d, i) => {
          stackedData.push({
            ...d,
            stackIndex: i,
            centerX: tick // Center on the tick position
          });
        });
      });

      // draw symbols
      const pts = plotG.selectAll('.point-dot').data(stackedData, d=>d.id);
      pts.enter()
        .append('text')
        .attr('class','point-dot')
        .attr('text-anchor','middle')
        .attr('dominant-baseline','middle')
        .attr('font-size', symbolSize + 'px')
        .merge(pts)
        .transition().duration(350)
        .attr('x', d => xScale(d.centerX)) // Center on tick
        .attr('y', d => height - (symbolSize + stackGap) * d.stackIndex - symbolSize/2 - 2)
        .text(d => {
          switch(d.category){
            case 'tp': return 'â–¢';
            case 'fn': return 'â–£';
            case 'tn': return 'â—‹';
            case 'fp': return 'â—‰';
          }
        })
        .attr('fill', d=>{
          if (d.category==='tp') return '#5eb979';
          if (d.category==='fn') return '#f8a12f';
          if (d.category==='tn') return '#3393e6';
          return '#ea5252';
        });
      pts.exit().remove();

      // move threshold line
      thresholdLine
        .attr('x1', xScale(currentThreshold))
        .attr('x2', xScale(currentThreshold));

      // confusion matrix counts
      let tp=0, fp=0, fn=0, tn=0;
      data.forEach(d => {
        const pred = d.score >= currentThreshold ? 1 : 0;
        if      (d.label===1 && pred===1) tp++;
        else if (d.label===0 && pred===1) fp++;
        else if (d.label===1 && pred===0) fn++;
        else                               tn++;
      });
      document.getElementById('cm-tp-count').textContent = tp;
      document.getElementById('cm-fp-count').textContent = fp;
      document.getElementById('cm-fn-count').textContent = fn;
      document.getElementById('cm-tn-count').textContent = tn;

      // performance metrics
      const acc    = (tp+tn)/data.length;
      const prec   = tp+fp>0 ? tp/(tp+fp) : 0;
      const recall = tp+fn>0 ? tp/(tp+fn) : 0;
      const f1     = prec+recall>0 ? 2*(prec*recall)/(prec+recall) : 0;
      document.getElementById('acc-metric').textContent    = acc.toFixed(3);
      document.getElementById('prec-metric').textContent   = prec.toFixed(3);
      document.getElementById('recall-metric').textContent = recall.toFixed(3);
      document.getElementById('f1-metric').textContent     = f1.toFixed(3);
    }

    // --- Event listeners ---
    document.getElementById('thresholdSlider').addEventListener('input', e => {
      currentThreshold = +e.target.value;
      document.getElementById('thresholdValue').textContent = currentThreshold.toFixed(2);
      updateVisualization();
    });

    document.querySelectorAll('.dataset-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.dataset-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentDataset = this.dataset.ds;
        currentThreshold = 0.5;
        document.getElementById('thresholdSlider').value = 0.5;
        document.getElementById('thresholdValue').textContent = '0.50';
        updateVisualization();
      });
    });

    // initial render
    updateVisualization();
  </script>
</body>
</html>
